#!/bin/sh

config_mk="config.mk"
prefix="\$(HOME)"

usage_message="Usage: ./configure
Check dependencies and produce a config.mk file to be sourced by Makefile
--prefix=<dir>             Install architecture-independent files in \$prefix
"

print_ok_fail () {
	# Usage: print_ok_fail <status> <message>...
	# <status> 0=ok; 1-127=fail
	status=$1
	shift
	if [ "$status" = "0" ]; then
		printf '%b\n' "[ OK ] $*"
	else
		printf '%b\n' "[FAIL] $*"
		exit 1
	fi
}

check_bin () {
	type "$*" >/dev/null 2>&1
	print_ok_fail $? $*
}

check_lib () {
	pkg-config "$*" >/dev/null 2>&1
	print_ok_fail $? $*
}

bins="\
	pkg-config \
	make \
	gcc \
	scdoc \
	meson \
	bash \
	python3 \
	dialog \
	swaybg \
	foot \
	wlr-randr \
	wtype \
	labwc-menu-generator \
"
libs="\
	glib-2.0 \
"

check_core_dependencies () {
	for bin in $bins; do
		check_bin "$bin"
	done
	for lib in $libs; do
		check_lib "$lib"
	done

	./configure-helpers/check-dep-pyqt6.py
	print_ok_fail $? PyQt6
}

check_prefix_in_path () {
	if [ $prefix = "\$(HOME)" ]; then
		bindir=$HOME/bin
	else
		bindir=$prefix/bin
	fi
	echo $bindir
	case $PATH in
	*$bindir*)
		printf '%b\n' "[ OK ] $bindir exists in \$PATH"
	        break ;;
	*)
		printf '%b\n' "[FAIL] $bindir not in \$PATH; please adjust your \$PATH"
	        exit 1 ;;
	esac
}

add () {
	printf '%b\n' "$*" >>"$config_mk"
}

main () {
	for arg
	do
		opt=${arg%%=*}
		var=${arg#*=}
		case "$opt" in
		--prefix)
			prefix="$var" ;;
		-h|--help)
			printf '%b' "$usage_message"; exit 1 ;;
		*)
			printf '%b\n' "warn: unknown option $opt" >&2 ;;
		esac
	done

	check_prefix_in_path
	check_core_dependencies

	rm -rf $config_mk
	add "prefix = $prefix"
}

main "$@"
